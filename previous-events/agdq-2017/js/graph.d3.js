"use strict";var svg,brush,games,x2,tot_data;function adjustToLast(b){var a=new Date();if(a-b<tot_data[0].date){openBrush({clearAtEnd:true})}else{adjustBrush(a-b,a)}}function adjustBrush(d,b,c,a){d=new Date(d);b=new Date(b);c=c||1000;a=a||false;d3.selectAll(".brush").transition().duration(c).call(brush.extent([d,b])).call(brush.event).each("end",function(){if(a){setTimeout(function(){d3.selectAll(".brush").call(brush.clear()).call(brush);$(".gameSelector").siblings().removeClass("selected")},50)}})}function openBrush(c){var e=x2.domain()[0];var a=x2.domain()[1];var d=c.duration||1000;var b=c.clearAtEnd||false;adjustBrush(e,a,d,b)}function drawGraph(D,Q,n,j,A,v){d3.select(D).selectAll("div").remove();var h={top:20,right:75,bottom:30,left:75},a=$(D).width()-h.left-h.right,e=$(D).height()-75-h.top-h.bottom,M={top:e+50,right:10,bottom:35,left:0},z=$(D).height()-M.top-M.bottom;var f=undefined;var p=false;if(brush&&!brush.empty()&&brush.extent()){f=brush.extent();if(x2&&x2.domain()&&(x2.domain()[1].toString()===f[1].toString()||x2.domain()[1].getTime().toString()==f[1])){p=true}}var G=d3.time.scale().range([0,a]);x2=d3.time.scale().range([0,a]);var b=d3.scale.linear().range([e,0]);var U=d3.scale.linear().range([e,0]);var T=d3.scale.linear().range([z,0]);var R=d3.scale.linear().range([z,0]);var w=d3.svg.axis().scale(G).orient("bottom");var i=d3.svg.axis().scale(x2).orient("bottom");var B=d3.svg.axis().scale(b).orient("left").tickFormat(function(x){return n(x)});var m=d3.svg.axis().scale(U).orient("right").tickFormat(function(x){return j(x)});var O=d3.svg.line().defined(function(x){return x.date>0&&x.primVal>=0}).x(function(x){return G(x.date)}).y(function(x){return b(x.primVal)}).interpolate("monotone");var c=d3.svg.line().defined(function(x){return x.date>0&&x.secVal>=0}).x(function(x){return G(x.date)}).y(function(x){return U(x.secVal)}).interpolate("monotone");var E=d3.svg.line().defined(function(x){return x.date>0&&x.primVal>=0}).x(function(x){return x2(x.date)}).y(function(x){return T(x.primVal)}).interpolate("basis");var P=d3.svg.line().defined(function(x){return x.date>0&&x.secVal>=0}).x(function(x){return x2(x.date)}).y(function(x){return R(x.secVal)}).interpolate("basis");svg=d3.select(D).append("div").append("svg").attr("width",a+h.left+h.right).attr("height",e+h.top+h.bottom+z+M.bottom+M.top).append("g").attr("transform","translate("+h.left+","+h.top+")");var S=svg.append("g").attr("class","context").attr("transform","translate("+M.left+","+M.top+")");function K(x){return x.date<G.domain()[1].getTime()&&x.date>G.domain()[0].getTime()}function r(){var V=binarySearch(tot_data,{date:G.domain()[0]},function(X,W){return X.date-W.date});var x=binarySearch(tot_data,{date:G.domain()[1]},function(X,W){return X.date-W.date});return[x-V,V,x]}function q(){var V=r();var x=V[0]/a;var W=Math.max([V[1]-5,0]);return tot_data.slice(W,V[2]+5).filter(function(Y,X){return X%Math.ceil(x)==0&&K(Y)})}function k(){G.domain(brush.empty()?x2.domain():brush.extent());Q=q();b.domain(d3.extent(Q,function(V){return V.primVal>=0?V.primVal:NaN}));U.domain(d3.extent(Q,function(V){return V.secVal>=0?V.secVal:NaN}));svg.select(".line.primaryLine").datum(Q).attr("d",O);svg.select(".line.secondaryLine").datum(Q).attr("d",c);svg.select(".x.axis.top").call(w);svg.select(".y.axis.leftAxis").call(B);svg.select(".y.axis.rightAxis").call(m);var x=new Date();J.selectAll(".line").data(games).attr("x1",function(V){return V.start_time<x?G(V.start_time):0}).attr("x2",function(V){return V.start_time<x?G(V.start_time):0})}brush=d3.svg.brush().x(x2).on("brush",k).on("brushend",function(){$(".gameSelector").siblings().removeClass("selected")}).clear();G.domain(d3.extent(Q,function(x){return x.date}));x2.domain(G.domain());Q=q();b.domain(d3.extent(Q,function(x){return x.primVal>=0?x.primVal:NaN}));U.domain(d3.extent(Q,function(x){return x.secVal>=0?x.secVal:NaN}));T.domain(b.domain());R.domain(U.domain());svg.append("g").attr("class","x axis top").attr("transform","translate(0,"+e+")").call(w);svg.append("g").attr("class","y axis leftAxis").call(B).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text(A);svg.append("path").datum(Q).attr("class","line primaryLine").attr("d",O);svg.append("path").datum(Q).attr("class","line secondaryLine").attr("d",c);svg.append("g").attr("class","y axis rightAxis").attr("transform","translate("+a+" ,0)").call(m).append("text").attr("transform","rotate(-90)").attr("y",-6).attr("dy",".6 0em").style("text-anchor","end").text(v);var J=svg.append("g");var I=new Date();J.selectAll("g").data(games).enter().append("line").attr("class","line gameLine").attr("x1",function(x){return G(x.start_time)}).attr("x2",function(x){return G(x.start_time)}).style("display",function(x){return x.start_time<I?"":"none"}).attr("y1",e-8).attr("y2",e);S.append("path").datum(Q).attr("class","line primContextLine").attr("d",E);S.append("path").datum(Q).attr("class","line secContextLine").attr("d",P);S.append("g").attr("class","x axis").attr("transform","translate(0,"+z+")").call(i);S.append("g").attr("class","x brush").call(brush).selectAll("rect").attr("y",-6).attr("height",z+7);S.append("rect").attr("class","contextBound").attr("width",a).attr("height",z+7).attr("transform","translate(0,-6)");svg.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",a).attr("height",e+10).attr("transform","translate(0,-5)");var F=svg.append("g").attr("class","focusline");var o=F.append("line").style("display","none").style("stroke","#bbb");var l=svg.append("g").style("display","none");l.append("circle").attr("r",3).attr("class","primaryFocus");var L=svg.append("g").style("display","none");L.append("circle").attr("r",3).attr("class","secondaryFocus");svg.append("rect").attr("class","overlay").attr("width",a).attr("height",e).on("mouseover",function(){l.style("display",null);L.style("display",null);o.style("display",null);g.style("display",null)}).on("mouseout",function(){l.style("display","none");L.style("display","none");o.style("display","none");g.style("display","none")}).on("mousemove",s).on("click",C);var g=d3.select(D).append("div").attr("class","tooltip").style("border","none").html("<div class='tool-game'></div><div class='tool-date'></div><div class='tool-primary'></div><div class='tool-secondary'></div><div class='tool-footer'>Click to toggle zoom.</div>").style("display","none");var y=$(".tool-game");var N=$(".tool-date");var H=$(".tool-primary");var d=$(".tool-secondary");var u=d3.bisector(function(x){return x.date}).left;var t=d3.bisector(function(x){return x.start_time}).left;function s(){var W=G.invert(d3.mouse(this)[0]),V=u(Q,W,1),Z=Q[V-1],Y=Q[V],aa=Y===undefined?Z:(W-Z.date>Y.date-W?Y:Z);var x=t(games,W,1),X=games[x-1];if(aa.primVal>=0){l.attr("transform","translate("+G(aa.date)+","+b(aa.primVal)+")").attr("display",null)}else{l.attr("display","none")}if(aa.secVal>=0){L.attr("transform","translate("+G(aa.date)+","+U(aa.secVal)+")").attr("display",null)}else{L.attr("display","none")}o.attr("x1",G(aa.date)).attr("x2",G(aa.date)).attr("y1",0).attr("y2",e).attr("display",null);y.text((aa.date<X.start_time)?"":X.name);N.text(moment(parseInt(aa.date)).format("llll"));H.text(A+": "+(aa.primVal>=0?n(aa.primVal):"No data"));d.text(v+": "+(aa.secVal>=0?j(aa.secVal):"No data"));g.style("text-alight","left").style("top",(d3.event.pageY-20)+"px").style("border",null);if(d3.event.pageX+20+g.node().getBoundingClientRect().width<window.innerWidth){g.style("left",(d3.event.pageX+20)+"px")}else{g.style("left",(d3.event.pageX-20-g.node().getBoundingClientRect().width)+"px")}}function C(){var V=G.invert(d3.mouse(this)[0]);var x=t(games,V,1);adjustToGame(x-1)}d3.select(D).selectAll("img").remove();if(f){adjustBrush(f[0],p?x2.domain()[1]:f[1],1,false)}}function adjustToGame(b){var c=new Date(games[b].start_time);if(c>tot_data[tot_data.length-1].date){return}var a=new Date((b+1<games.length&&games[b+1].start_time<=tot_data[tot_data.length-1].date)?games[b+1].start_time:tot_data[tot_data.length-1].date);if(brush.empty()){openBrush({duration:0})}else{if(brush.extent()[0].getTime()==c.getTime()&&brush.extent()[1].getTime()==a.getTime()){openBrush({clearAtEnd:true});return}}adjustBrush(c,a)}function binarySearch(c,e,d){var a=0;var g=c.length-1;while(a<=g){var b=(g+a)>>1;var f=d(e,c[b]);if(f>0){a=b+1}else{if(f<0){g=b-1}else{return b}}}return a+1}function renderGames(){var g=$("<table id='gamesTable'>");g.append("<thead><tr><th style='width:5px'></th><th style='width:340px'>Title</th><th style='width:340px'>Runner</th><th style='width:140px'>Starting Time</th><th>Duration</th></tr></thead><tbody>");var f=0;for(var c in games){var b="<tr class='gameSelector' id='"+c+"'><td style='width:5px'></td><td style='width:340px' id ='"+c+"'>"+games[c].name+"</td><td style='width:340px' id ='"+c+"'>"+games[c].runners+"</td>";var a=moment(parseInt(games[c].start_time)).format("MMM D, h:mm a")+" "+(parseInt(games[c].start_time)<(new Date()).getTime()?"✓":"");b+="<td class='"+c+"duration' style='width:140px' id ='"+c+"'>"+a+"</td>";b+="<td id ='"+c+"'>"+games[c].duration+"</td></tr>";g.append(b);if(parseInt(games[c].start_time)<(new Date()).getTime()){f+=1}if(parseInt(games[c].start_time)>=(new Date()).getTime()){setTimeout(function(h){$("."+h+"duration").first().text(moment(parseInt(games[h].start_time)).format("MMM D, h:mm a")+" ✓")},parseInt(games[c].start_time)-(new Date()).getTime(),c)}}g.append("</tbody>");$("#game-list").append(g);$(".gameSelector").on("click",function(j){var i=j.toElement||j.currentTarget;var h=parseInt(i.id);adjustToGame(h);if(parseInt(games[h].start_time)<(new Date()).getTime()){$(this).toggleClass("selected").siblings().removeClass("selected");$(this).get(0).scrollIntoView();$("#chart-div").get(0).scrollIntoView()}});var d=$("#game-list");var e=$("#"+(f-1));if(e.get(0)){e.get(0).scrollIntoView();window.scrollTo(0,0)}}function conditionData(f,a,d){var b=[];var e;for(var c in f){e={primVal:f[c][a],secVal:f[c][d],date:parseInt(c)};if(e.primVal>=0||e.secVal>=0){b.push(e)}}b=b.sort(function(h,g){return h.date-g.date});tot_data=b;return b}function conditionGames(c){var a=[];var d;for(var b in c){d=c[b];d.start_time=moment(d.start_time).valueOf();a.push(d)}a=a.sort(function(f,e){return f.start_time-e.start_time});games=a}var seriesMap={Viewers:{key:"v",format:d3.format(",.0f")},Donations:{key:"m",format:d3.format("$,.0f")},"Donations per Minute":{key:"dpm",format:d3.format("$,.0f")},Donators:{key:"d",format:d3.format(",.0f")},Tweets:{key:"tt",format:d3.format(",.0f")},"Tweets per Minute":{key:"t",format:d3.format(",.0f")},"Twitch Chats":{key:"ct",format:d3.format(",.0f")},"Twitch Chats per Minute":{key:"c",format:d3.format(",.0f")},"Twitch Emotes":{key:"et",format:d3.format(",.0f")},"Twitch Emotes per Minute":{key:"e",format:d3.format(",.0f")},Disabled:{key:"l",format:d3.format()}};function selectChanged(){var a=$("#primSelect"),d=$("#secSelect"),c=a.find(":selected").text(),b=d.find(":selected").text();a.find("option").prop("disabled",false);d.find("option").prop("disabled",false);a.find("option[value='"+b+"']").prop("disabled",true);d.find("option[value='"+c+"']").prop("disabled",true);Cookies.set("sel1",c);Cookies.set("sel2",b);render(c,b)}var raw_data;function render(d,c){var b=seriesMap[d];var a=seriesMap[c];if(d=="Disabled"){d=""}if(c=="Disabled"){c=""}var e=conditionData(raw_data,b.key,a.key);drawGraph("#chart",e,b.format,a.format,d,c)}function generateSyntheticSeries(a){var e=undefined,g=0,h=0,f=0;var c,d=Object.keys(a);d=d.sort();for(var b=0;b<d.length;b++){c=d[b];if(a[c].t){g+=a[c].t}a[c].tt=g;if(a[c].c){h+=a[c].c}a[c].ct=h;if(a[c].e){f+=a[c].e}a[c].et=f;if(!e){e=c;a[c].dpm=0;continue}if(a[c].m>=0){a[c].dpm=a[c].m-a[e].m;e=c}if(!a[c].dpm||a[c].dpm<0){a[c].dpm=0}}return a}function loadSelectCookies(){var b=Cookies.get("sel1"),a=Cookies.get("sel2");if(b){$("#primSelect").find("option[value='"+b+"']").prop("selected",true)}if(a){$("#secSelect").find("option[value='"+a+"']").prop("selected",true)}}function initialSetup(){raw_data=generateSyntheticSeries(raw_data);loadSelectCookies();selectChanged();renderGames()}var shouldRerender=false;function handleTimeseries(c){var d={};for(var b=0;b<c.length;b++){var a=Date.parse(c[b].time);d[a]=c[b]}raw_data=d;shouldRerender=true}function handleSchedule(a){conditionGames(a)}DBConnection.getTimeseries().then(function(a){handleTimeseries(a);DBConnection.getSchedule().then(function(b){handleSchedule(b);initialSetup();DBConnection.timeseriesListeners.push(handleTimeseries);DBConnection.scheduleListeners.push(handleSchedule)})});setInterval(function(){if(shouldRerender){raw_data=generateSyntheticSeries(raw_data);selectChanged();shouldRerender=false}},10*1000);