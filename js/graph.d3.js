"use strict";var svg,brush,games,x2,tot_data;function adjustBrush(d,b,c,a){c=c||1000;a=a||false;d3.selectAll(".brush").transition().duration(c).call(brush.extent([d,b])).call(brush.event).each("end",function(){if(a){setTimeout(function(){d3.selectAll(".brush").call(brush.clear()).call(brush);$(".gameSelector").siblings().removeClass("selected")},50)}})}function drawGraph(D,P,n,j,A,v){d3.select(D).selectAll("div").remove();var h={top:20,right:75,bottom:30,left:75},a=$(D).width()-h.left-h.right,e=$(D).height()-75-h.top-h.bottom,L={top:e+50,right:10,bottom:35,left:0},z=$(D).height()-L.top-L.bottom;var f=undefined;var p=false;if(brush&&!brush.empty()&&brush.extent()){f=brush.extent();if(x2&&x2.domain()&&(x2.domain()[1].toString()===f[1].toString()||x2.domain()[1].getTime().toString()==f[1])){p=true}}var G=d3.time.scale().range([0,a]);x2=d3.time.scale().range([0,a]);var b=d3.scale.linear().range([e,0]);var T=d3.scale.linear().range([e,0]);var S=d3.scale.linear().range([z,0]);var Q=d3.scale.linear().range([z,0]);var w=d3.svg.axis().scale(G).orient("bottom");var i=d3.svg.axis().scale(x2).orient("bottom");var B=d3.svg.axis().scale(b).orient("left").tickFormat(function(x){return n(x)});var m=d3.svg.axis().scale(T).orient("right").tickFormat(function(x){return j(x)});var N=d3.svg.line().defined(function(x){return x.date>0&&x.primVal>=0}).x(function(x){return G(x.date)}).y(function(x){return b(x.primVal)}).interpolate("monotone");var c=d3.svg.line().defined(function(x){return x.date>0&&x.secVal>=0}).x(function(x){return G(x.date)}).y(function(x){return T(x.secVal)}).interpolate("monotone");var E=d3.svg.line().defined(function(x){return x.date>0&&x.primVal>=0}).x(function(x){return x2(x.date)}).y(function(x){return S(x.primVal)}).interpolate("basis");var O=d3.svg.line().defined(function(x){return x.date>0&&x.secVal>=0}).x(function(x){return x2(x.date)}).y(function(x){return Q(x.secVal)}).interpolate("basis");svg=d3.select(D).append("div").append("svg").attr("width",a+h.left+h.right).attr("height",e+h.top+h.bottom+z+L.bottom+L.top).append("g").attr("transform","translate("+h.left+","+h.top+")");var R=svg.append("g").attr("class","context").attr("transform","translate("+L.left+","+L.top+")");function J(x){return x.date<G.domain()[1].getTime()&&x.date>G.domain()[0].getTime()}function r(){var U=binarySearch(tot_data,{date:G.domain()[0]},function(W,V){return W.date-V.date});var x=binarySearch(tot_data,{date:G.domain()[1]},function(W,V){return W.date-V.date});return[x-U,U,x]}function q(){var U=r();var x=U[0]/a;var V=Math.max([U[1]-5,0]);return tot_data.slice(V,U[2]+5).filter(function(X,W){return W%Math.ceil(x)==0&&J(X)})}function k(){G.domain(brush.empty()?x2.domain():brush.extent());P=q();b.domain(d3.extent(P,function(x){return x.primVal>=0?x.primVal:NaN}));T.domain(d3.extent(P,function(x){return x.secVal>=0?x.secVal:NaN}));svg.select(".line.primaryLine").datum(P).attr("d",N);svg.select(".line.secondaryLine").datum(P).attr("d",c);svg.select(".x.axis.top").call(w);svg.select(".y.axis.leftAxis").call(B);svg.select(".y.axis.rightAxis").call(m);I.selectAll(".line").data(games).attr("x1",function(x){return G(x.start_time)}).attr("x2",function(x){return G(x.start_time)})}brush=d3.svg.brush().x(x2).on("brush",k).on("brushend",function(){$(".gameSelector").siblings().removeClass("selected")}).clear();G.domain(d3.extent(P,function(x){return x.date}));x2.domain(G.domain());P=q();b.domain(d3.extent(P,function(x){return x.primVal>=0?x.primVal:NaN}));T.domain(d3.extent(P,function(x){return x.secVal>=0?x.secVal:NaN}));S.domain(b.domain());Q.domain(T.domain());svg.append("g").attr("class","x axis top").attr("transform","translate(0,"+e+")").call(w);svg.append("g").attr("class","y axis leftAxis").call(B).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text(A);svg.append("path").datum(P).attr("class","line primaryLine").attr("d",N);svg.append("path").datum(P).attr("class","line secondaryLine").attr("d",c);svg.append("g").attr("class","y axis rightAxis").attr("transform","translate("+a+" ,0)").call(m).append("text").attr("transform","rotate(-90)").attr("y",-6).attr("dy",".6 0em").style("text-anchor","end").text(v);var I=svg.append("g");I.selectAll("g").data(games).enter().append("line").attr("class","line gameLine").attr("x1",function(x){return G(x.start_time)}).attr("x2",function(x){return G(x.start_time)}).attr("y1",e-8).attr("y2",e);R.append("path").datum(P).attr("class","line primContextLine").attr("d",E);R.append("path").datum(P).attr("class","line secContextLine").attr("d",O);R.append("g").attr("class","x axis").attr("transform","translate(0,"+z+")").call(i);R.append("g").attr("class","x brush").call(brush).selectAll("rect").attr("y",-6).attr("height",z+7);R.append("rect").attr("class","contextBound").attr("width",a).attr("height",z+7).attr("transform","translate(0,-6)");svg.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",a).attr("height",e+10).attr("transform","translate(0,-5)");var F=svg.append("g").attr("class","focusline");var o=F.append("line").style("display","none").style("stroke","#bbb");var l=svg.append("g").style("display","none");l.append("circle").attr("r",3).attr("class","primaryFocus");var K=svg.append("g").style("display","none");K.append("circle").attr("r",3).attr("class","secondaryFocus");svg.append("rect").attr("class","overlay").attr("width",a).attr("height",e).on("mouseover",function(){l.style("display",null);K.style("display",null);o.style("display",null);g.style("display",null)}).on("mouseout",function(){l.style("display","none");K.style("display","none");o.style("display","none");g.style("display","none")}).on("mousemove",s).on("click",C);var g=d3.select(D).append("div").attr("class","tooltip").style("border","none").html("<div class='tool-game'></div><div class='tool-date'></div><div class='tool-primary'></div><div class='tool-secondary'></div><div class='tool-footer'>Click to toggle zoom.</div>").style("display","none");var y=$(".tool-game");var M=$(".tool-date");var H=$(".tool-primary");var d=$(".tool-secondary");var u=d3.bisector(function(x){return x.date}).left;var t=d3.bisector(function(x){return x.start_time}).left;function s(){var V=G.invert(d3.mouse(this)[0]),U=u(P,V,1),Y=P[U-1],X=P[U],Z=X===undefined?Y:(V-Y.date>X.date-V?X:Y);var x=t(games,V,1),W=games[x-1];if(Z.primVal>=0){l.attr("transform","translate("+G(Z.date)+","+b(Z.primVal)+")").attr("display",null)}else{l.attr("display","none")}if(Z.secVal>=0){K.attr("transform","translate("+G(Z.date)+","+T(Z.secVal)+")").attr("display",null)}else{K.attr("display","none")}o.attr("x1",G(Z.date)).attr("x2",G(Z.date)).attr("y1",0).attr("y2",e).attr("display",null);y.text((Z.date<W.start_time)?"":W.title);M.text(moment(parseInt(Z.date)).format("llll"));H.text(A+": "+(Z.primVal>=0?n(Z.primVal):"No data"));d.text(v+": "+(Z.secVal>=0?j(Z.secVal):"No data"));g.style("left",(d3.event.pageX+20)+"px").style("text-alight","left").style("top",(d3.event.pageY-20)+"px").style("border",null)}function C(){var U=G.invert(d3.mouse(this)[0]);var x=t(games,U,1);adjustToGame(x-1)}d3.select(D).selectAll("img").remove();if(f){adjustBrush(f[0],p?x2.domain()[1]:f[1],1,false)}}function adjustToGame(b){var c=games[b].start_time;if(c>tot_data[tot_data.length-1].date){return}var a=(b+1<games.length&&games[b+1].start_time<=tot_data[tot_data.length-1].date)?games[b+1].start_time:tot_data[tot_data.length-1].date;if(brush.empty()){adjustBrush(x2.domain()[0],x2.domain()[1],0)}else{if(brush.extent()[0]==c&&brush.extent()[1]==a){c=x2.domain()[0];a=x2.domain()[1];adjustBrush(c,a,1000,true);return}}adjustBrush(c,a)}function binarySearch(c,e,d){var a=0;var g=c.length-1;while(a<=g){var b=(g+a)>>1;var f=d(e,c[b]);if(f>0){a=b+1}else{if(f<0){g=b-1}else{return b}}}return a+1}function renderGames(){var g=$("<table id='gamesTable'>");g.append("<thead><tr><th style='width:5px'></th><th style='width:340px'>Title</th><th style='width:340px'>Runner</th><th style='width:140px'>Starting Time</th><th>Duration</th></tr></thead><tbody>");var f=0;for(var c in games){var b="<tr class='gameSelector' id='"+c+"'><td style='width:5px'></td><td style='width:340px' id ='"+c+"'>"+games[c].title+"</td><td style='width:340px' id ='"+c+"'>"+games[c].runner+"</td>";var a=moment(parseInt(games[c].start_time)).format("MMM D, h:mm a")+" "+(parseInt(games[c].start_time)<(new Date()).getTime()?"✓":"");b+="<td class='"+c+"duration' style='width:140px' id ='"+c+"'>"+a+"</td>";b+="<td id ='"+c+"'>"+games[c].duration+"</td></tr>";g.append(b);if(parseInt(games[c].start_time)<(new Date()).getTime()){f+=1}if(parseInt(games[c].start_time)>=(new Date()).getTime()){setTimeout(function(h){$("."+h+"duration").first().text(moment(parseInt(games[h].start_time)).format("MMM D, h:mm a")+" ✓")},parseInt(games[c].start_time)-(new Date()).getTime(),c)}}g.append("</tbody>");$("#game-list").append(g);$(".gameSelector").on("click",function(i){var h=parseInt(i.toElement.id);adjustToGame(h);if(parseInt(games[h].start_time)<(new Date()).getTime()){$(this).toggleClass("selected").siblings().removeClass("selected");$(this).get(0).scrollIntoView();$("#chart-div").get(0).scrollIntoView()}});var d=$("#game-list");var e=$("#"+(f-1));if(e.get(0)){e.get(0).scrollIntoView();window.scrollTo(0,0)}}function conditionData(f,a,d){var b=[];var e;for(var c in f){e={primVal:f[c][a],secVal:f[c][d],date:c};if(e.primVal>=0||e.secVal>=0){b.push(e)}}b=b.sort(function(h,g){return h.date-g.date});tot_data=b;return b}function conditionGames(c){var a=[];var d;for(var b in c){d=c[b];d.start_time=parseInt(d.start_time);a.push(d)}games=a}var seriesMap={Viewers:{key:"v",format:d3.format(",.0f")},Donations:{key:"m",format:d3.format("$,.0f")},"Donations per Minute":{key:"dpm",format:d3.format("$,.0f")},Donators:{key:"d",format:d3.format(",.0f")},Tweets:{key:"tt",format:d3.format(",.0f")},"Tweets per Minute":{key:"t",format:d3.format(",.0f")},"Twitch Chats":{key:"ct",format:d3.format(",.0f")},"Twitch Chats per Minute":{key:"c",format:d3.format(",.0f")},"Twitch Emotes":{key:"et",format:d3.format(",.0f")},"Twitch Emotes per Minute":{key:"e",format:d3.format(",.0f")}};function selectChanged(){var a=$("#primSelect"),d=$("#secSelect"),c=a.find(":selected").text(),b=d.find(":selected").text();a.find("option").prop("disabled",false);d.find("option").prop("disabled",false);a.find("option[value='"+b+"']").prop("disabled",true);d.find("option[value='"+c+"']").prop("disabled",true);Cookies.set("sel1",c);Cookies.set("sel2",b);render(c,b)}var raw_data;function render(d,c){var b=seriesMap[d];var a=seriesMap[c];drawGraph("#chart",conditionData(raw_data,b.key,a.key),b.format,a.format,d,c)}function generateSyntheticSeries(a){var e=undefined,g=0,h=0,f=0;var c,d=Object.keys(a);d=d.sort();for(var b=0;b<d.length;b++){c=d[b];if(a[c].t){g+=a[c].t}a[c].tt=g;if(a[c].c){h+=a[c].c}a[c].ct=h;if(a[c].e){f+=a[c].e}a[c].et=f;if(!e){e=c;a[c].dpm=0;continue}if(a[c].m>=0){a[c].dpm=a[c].m-a[e].m;e=c}if(!a[c].dpm||a[c].dpm<0){a[c].dpm=0}}return a}function loadSelectCookies(){var b=Cookies.get("sel1"),a=Cookies.get("sel2");if(b){$("#primSelect").find("option[value='"+b+"']").prop("selected",true)}if(a){$("#secSelect").find("option[value='"+a+"']").prop("selected",true)}}function getRetry(b,a){$.ajax({url:b,async:true,retryCount:0,retryLimit:5,retryTimeout:15000,timeout:2000,created:Date.now(),error:function(d,e,c){this.retryCount++;if(this.retryCount<=this.retryLimit&&Date.now()-this.created<this.retryTimeout){console.log("Retrying");$.ajax(this);return}},success:a})}getRetry("https://www.googleapis.com/storage/v1/b/sgdq-backend.appspot.com/o/latest.json",function(a){getRetry(a.mediaLink,setupAll)});function setupAll(a){raw_data=jQuery.extend(true,a.data,a.extras);raw_data=generateSyntheticSeries(raw_data);conditionGames(a.games);loadSelectCookies();selectChanged();renderGames()}var shouldRerender=false;var data_ref=firebase.database().ref("data");data_ref.on("child_changed",function(d,b){var a=d.getKey();var c=d.val();if(!raw_data[a]){raw_data[a]={}}raw_data[a].d=raw_data[a].d||c.d;raw_data[a].m=raw_data[a].m||c.m;raw_data[a].v=raw_data[a].v||c.v;shouldRerender=true});var extras_ref=firebase.database().ref("extras");extras_ref.on("child_changed",function(d,b){var a=d.getKey();var c=d.val();if(!raw_data[a]){raw_data[a]={}}raw_data[a].t=raw_data[a].t||c.t;raw_data[a].e=raw_data[a].e||c.e;raw_data[a].c=raw_data[a].c||c.c;shouldRerender=true});setInterval(function(){if(shouldRerender){raw_data=generateSyntheticSeries(raw_data);selectChanged();shouldRerender=false}},10000);