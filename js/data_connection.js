"use strict";const GDQ_API_ENDPOINT="https://api.gdqstat.us";const GDQ_STORAGE_ENDPOINT="data/2017/agdq_final";var DBConnection={timeseries:undefined,schedule:undefined,timeseriesListeners:[],scheduleListeners:[],fetchInitial:function(){return new Promise(function(b,a){getRetry(GDQ_STORAGE_ENDPOINT+"/latest.json",function(c){c=(typeof c==="string"||c instanceof String)?JSON.parse(c):c;DBConnection.updateWithNewData(c);DBConnection.fetchRecent().then(function(){b()})})})},fetchRecent:function(){return new Promise(function(b,a){b(DBConnection.timeseries)})},updateWithNewData:function(d){for(var b=0;b<d.length;b++){d[b].time=new Date(d[b].time);for(var a in d[b]){if(d[b][a]==null){d[b][a]=-1}}}d.sort(function(f,e){return f.time-e.time});if(!DBConnection.timeseries||DBConnection.timeseries.length==0){DBConnection.timeseries=d}else{var c=DBConnection.mostRecentTime();d=d.filter(function(e){return e.time>c});DBConnection.timeseries=DBConnection.timeseries.concat(d)}DBConnection.callTimeseriesListeners()},mostRecentTime:function(){if(!DBConnection.timeseries){return 0}return DBConnection.timeseries[DBConnection.timeseries.length-1].time},refreshTimeseries:function(){return new Promise(function(b,a){DBConnection.fetchRecent().then(function(){b(DBConnection.timeseries)})})},refreshSchedule:function(){return new Promise(function(c,a){var b=GDQ_STORAGE_ENDPOINT+"/schedule.json";getRetry(b,function(e){DBConnection.schedule=(typeof e==="string"||e instanceof String)?JSON.parse(e):e;for(var d=0;d<DBConnection.schedule.length;d++){DBConnection.schedule[d].start_time=moment.utc(DBConnection.schedule[d].start_time)}DBConnection.schedule.sort(function(g,f){return g.start_time-f.start_time});DBConnection.callScheduleListeners();c(DBConnection.schedule)})})},callTimeseriesListeners:function(){for(var a=0;a<DBConnection.timeseriesListeners.length;a++){DBConnection.timeseriesListeners[a](DBConnection.timeseries)}},callScheduleListeners:function(){for(var a=0;a<DBConnection.scheduleListeners.length;a++){DBConnection.scheduleListeners[a](DBConnection.schedule)}},getTimeseries:function(){return new Promise(function(b,a){if(DBConnection.timeseries){b(DBConnection.timeseries)}else{DBConnection.fetchInitial().then(function(){b(DBConnection.timeseries)})}})},getSchedule:function(){return new Promise(function(b,a){if(DBConnection.schedule){b(DBConnection.schedule)}else{DBConnection.refreshSchedule().then(function(){b(DBConnection.schedule)})}})}};DBConnection.fetchInitial();DBConnection.refreshSchedule();setInterval(function(){DBConnection.refreshTimeseries()},60*1000);setInterval(function(){DBConnection.refreshSchedule()},5*60*1000);