"use strict";const GDQ_API_ENDPOINT="https://t6htp02ube.execute-api.us-east-1.amazonaws.com/dev";const GDQ_STORAGE_ENDPOINT="https://s3.amazonaws.com/agdq-2017-dev";var DBConnection={timeseries:undefined,schedule:undefined,timeseriesListeners:[],scheduleListeners:[],fetchInitial:function(){return new Promise(function(b,a){getRetry(GDQ_STORAGE_ENDPOINT+"/latest.json",function(c){DBConnection.updateWithNewData(JSON.parse(c));DBConnection.fetchRecent().then(function(){b()})})})},fetchRecent:function(){return new Promise(function(d,b){var c=GDQ_API_ENDPOINT+"/recentEvents";var a=DBConnection.mostRecentTime();if(a){c+="?since="+a}getRetry(c,function(e){DBConnection.updateWithNewData(e);d(DBConnection.timeseries)})})},updateWithNewData:function(b){if(!DBConnection.timeseries||DBConnection.timeseries.length==0){DBConnection.timeseries=b}else{var a=DBConnection.mostRecentTime();b=b.filter(function(c){return c.time>a});b.sort(function(d,c){return(new Date(d.time))-(new Date(c.time))});DBConnection.timeseries.concat(b)}DBConnection.callTimeseriesListeners()},mostRecentTime:function(){if(!DBConnection.timeseries){return 0}return DBConnection.timeseries.reduce(function(d,c){return Math.max(d.t,c.t)},0)},refreshTimeseries:function(){return new Promise(function(b,a){DBConnection.fetchRecent().then(function(){b(DBConnection.timeseries)})})},refreshSchedule:function(){return new Promise(function(c,a){var b=GDQ_STORAGE_ENDPOINT+"/schedule.json";getRetry(b,function(d){DBConnection.schedule=JSON.parse(d);DBConnection.callScheduleListeners();c(DBConnection.schedule)})})},callTimeseriesListeners:function(){for(var a=0;a<DBConnection.timeseriesListeners.length;a++){DBConnection.timeseriesListeners[a](DBConnection.timeseries)}},callScheduleListeners:function(){for(var a=0;a<DBConnection.scheduleListeners.length;a++){DBConnection.scheduleListeners[a](DBConnection.schedule)}},getTimeseries:function(){return new Promise(function(b,a){if(DBConnection.timeseries){b(DBConnection.timeseries)}else{DBConnection.fetchInitial().then(function(){b(DBConnection.timeseries)})}})},getSchedule:function(){return new Promise(function(b,a){if(DBConnection.schedule){b(DBConnection.schedule)}else{DBConnection.refreshSchedule().then(function(){b(DBConnection.schedule)})}})}};DBConnection.fetchInitial();DBConnection.refreshSchedule();setInterval(function(){DBConnection.refreshTimeseries()},60*1000);setInterval(function(){DBConnection.refreshSchedule()},5*60*1000);